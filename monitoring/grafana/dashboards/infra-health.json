{
  "title": "Infrastructure Health",
  "uid": "dr-infra-health",
  "editable": true,
  "refresh": "5s",
  "time": { "from": "now-15m", "to": "now" },
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 2,
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Pipeline Throughput",
      "description": "Current events/sec flowing through the exporter. If this drops to 0, the pipeline is broken. Expect ~50 eps steady state.",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "targets": [{ "expr": "dr_events_per_second", "legendFormat": "eps" }],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "green", "value": 30 }
            ]
          },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "colorMode": "background", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Kafka Brokers",
      "description": "Alive brokers in the cluster. Must be 3 for full replication. <3 means degraded replication and risk of data loss if another broker fails.",
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
      "targets": [{ "expr": "kafka_brokers", "legendFormat": "brokers" }],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 2 },
              { "color": "green", "value": 3 }
            ]
          },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "colorMode": "background", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Detector Lag",
      "description": "Unprocessed messages for the detection-engine consumer group. Should stay <100. Rising lag = detectors can't keep up with ingestion. Scale replicas or investigate slow rules.",
      "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
      "targets": [{ "expr": "sum(kafka_consumergroup_lag{consumergroup=\"detection-engine\"})", "legendFormat": "messages" }],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 100 },
              { "color": "red", "value": 1000 }
            ]
          },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "colorMode": "background", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Exporter Lag",
      "description": "Unprocessed messages for the metrics-exporter. If this grows, these dashboards show stale data — monitoring itself is degraded.",
      "gridPos": { "x": 18, "y": 0, "w": 6, "h": 4 },
      "targets": [{ "expr": "sum(kafka_consumergroup_lag{consumergroup=\"metrics-exporter\"})", "legendFormat": "messages" }],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 100 },
              { "color": "red", "value": 1000 }
            ]
          },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "colorMode": "background", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "id": 5,
      "type": "timeseries",
      "title": "Kafka Topic Throughput",
      "description": "Messages/sec written to each topic — the ground truth for pipeline health. raw-api-events should track the generator's target EPS. alerts should be <<1% of raw events; if they approach parity, detection rules are miscalibrated.",
      "gridPos": { "x": 0, "y": 4, "w": 12, "h": 8 },
      "targets": [{ "expr": "sum by (topic) (rate(kafka_topic_partition_current_offset[1m]))", "legendFormat": "{{ topic }}" }],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 15, "showPoints": "never", "stacking": { "mode": "none" } }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "raw-api-events" }, "properties": [{ "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "alerts" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] } }
    },
    {
      "id": 6,
      "type": "timeseries",
      "title": "Consumer Lag by Partition",
      "description": "Per-partition lag for the detection engine's 3 replicas. Even distribution = healthy partitioning. One partition lagging while others are fine = that specific replica is unhealthy or overloaded.",
      "gridPos": { "x": 12, "y": 4, "w": 12, "h": 8 },
      "targets": [{ "expr": "kafka_consumergroup_lag{consumergroup=\"detection-engine\"}", "legendFormat": "{{ topic }}/p{{ partition }}" }],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10, "showPoints": "never", "stacking": { "mode": "none" } }
        }
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max", "last"] } }
    },

    {
      "id": 7,
      "type": "timeseries",
      "title": "Simulated API Response Latency",
      "description": "Response latency of simulated Claude API requests (from the generator's latency_ms field, not internal pipeline latency). P50 = typical experience. P99 = tail latency. P99 spiking while P50 stays flat means a small subset of requests (large contexts, complex prompts) is hitting edge cases.",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "targets": [
        { "expr": "histogram_quantile(0.50, sum by (le) (rate(dr_request_latency_milliseconds_bucket[5m])))", "legendFormat": "p50" },
        { "expr": "histogram_quantile(0.95, sum by (le) (rate(dr_request_latency_milliseconds_bucket[5m])))", "legendFormat": "p95" },
        { "expr": "histogram_quantile(0.99, sum by (le) (rate(dr_request_latency_milliseconds_bucket[5m])))", "legendFormat": "p99" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10, "showPoints": "never" }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "p50" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "p95" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "p99" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] } }
    },
    {
      "id": 8,
      "type": "timeseries",
      "title": "Data Volume (tokens/sec)",
      "description": "Token throughput — the actual data volume flowing through the API. Cache-read relative to input shows cache effectiveness. Input spiking with near-zero cache = likely token stuffing (users sending max-context requests with no reuse).",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "targets": [
        { "expr": "rate(dr_input_tokens_total[1m])", "legendFormat": "input tokens/s" },
        { "expr": "rate(dr_output_tokens_total[1m])", "legendFormat": "output tokens/s" },
        { "expr": "rate(dr_cache_read_tokens_total[1m])", "legendFormat": "cache read tokens/s" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10, "showPoints": "never", "stacking": { "mode": "none" } }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "input tokens/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "output tokens/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "cache read tokens/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "purple", "mode": "fixed" } }] }
        ]
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] } }
    }
  ]
}
